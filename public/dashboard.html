<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZapManejo - Painel de Controle</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #27ae60;
        }

        .ranch-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .ranch-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .trial-timer {
            background: #ff6b6b;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        /* Tab Navigation */
        .tab-nav {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 70px;
            z-index: 99;
        }

        .tab-nav-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            color: #666;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #f8f9fa;
            color: #27ae60;
        }

        .tab-btn.active {
            color: #27ae60;
            border-bottom-color: #27ae60;
        }

        .tab-btn span {
            margin-right: 8px;
        }

        /* Tab Content */
        .tab-content {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Dashboard Overview */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }

        .stat-change {
            color: #27ae60;
            font-size: 14px;
            margin-top: 5px;
        }

        /* Inventory Table */
        .inventory-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .filter-btn, .action-btn {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .filter-btn:hover, .action-btn:hover {
            background: #229954;
        }

        .inventory-table {
            background: white;
            border-radius: 10px;
            overflow: auto;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .tag-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 13px;
        }

        .status-healthy {
            color: #27ae60;
        }

        .status-sick {
            color: #ff6b6b;
        }

        /* WhatsApp Hub */
        .whatsapp-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .message-list {
            background: white;
            border-radius: 10px;
            overflow-y: auto;
            padding: 20px;
        }

        .message-item {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .message-item:hover {
            background: #f8f9fa;
        }

        .message-sender {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .message-preview {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .message-time {
            color: #999;
            font-size: 12px;
        }

        .chat-window {
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #e5ddd5;
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
        }

        .chat-message.sent {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 10px;
            background: white;
        }

        .message-bubble.sent {
            background: #dcf8c6;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
        }

        .send-btn {
            padding: 10px 20px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Weather Widget */
        .weather-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .weather-temp {
            font-size: 48px;
            font-weight: bold;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        /* File Upload */
        .upload-zone {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: #27ae60;
            background: #f8f9fa;
        }

        .upload-icon {
            font-size: 48px;
            color: #999;
            margin-bottom: 10px;
        }

        /* Milk Production */
        .milk-form {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .form-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .whatsapp-container {
                grid-template-columns: 1fr;
            }
            
            .tab-nav-content {
                overflow-x: auto;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .notification.show {
            display: block;
        }
    </style>
    <!-- Add Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <span>üêÑ</span>
                <span>ZapManejo</span>
            </div>
            <div class="ranch-info">
                <select id="languageSelector" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; margin-right: 15px;">
                    <option value="pt">üáßüá∑ Portugu√™s</option>
                    <option value="es">üá™üá∏ Espa√±ol</option>
                    <option value="en">üá∫üá∏ English</option>
                </select>
                <div class="ranch-name" id="ranchName">Fazenda Demo</div>
                <div class="trial-timer" id="trialTimer">36:00:00 restantes</div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <div class="tab-nav-content">
            <button class="tab-btn active" onclick="switchTab('dashboard', this)">
                <span>üìä</span>Painel
            </button>
            <button class="tab-btn" onclick="switchTab('inventory', this)">
                <span>üìã</span>Invent√°rio
            </button>
            <button class="tab-btn" onclick="switchTab('whatsapp', this)">
                <span>üí¨</span>WhatsApp
            </button>
            <button class="tab-btn" onclick="switchTab('analytics', this)">
                <span>üìà</span>An√°lises
            </button>
            <button class="tab-btn" onclick="switchTab('weather', this)">
                <span>‚òÅÔ∏è</span>Clima
            </button>
            <button class="tab-btn" onclick="switchTab('milk', this)">
                <span>ü•õ</span>Produ√ß√£o de Leite
            </button>
            <button class="tab-btn" onclick="switchTab('documents', this)">
                <span>üìÅ</span>Documentos
            </button>
        </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard-tab">
        <!-- Demo Notice -->
        <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <strong>‚ö†Ô∏è Modo Demonstra√ß√£o</strong> - Os dados mostrados s√£o fict√≠cios. Quando voc√™ se tornar assinante, voc√™ poder√°:
            <ul style="margin-top: 10px; margin-left: 20px;">
                <li>Cadastrar seus pastos reais com nomes e tamanhos personalizados</li>
                <li>Registrar seu rebanho completo: <strong>Bovinos üêÑ, Equinos üê¥, Su√≠nos üê∑ e Ovinos üêë</strong></li>
                <li>Adicionar seus vaqueiros e funcion√°rios reais</li>
                <li>Configurar alertas personalizados e relat√≥rios</li>
            </ul>
            <strong>üìû Suporte completo inclu√≠do para todos os tipos de cria√ß√£o!</strong>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total de Animais</div>
                <div class="stat-value" id="totalCattle">150</div>
                <div class="stat-change">üêÑ Bovinos: 150</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Nascimentos (M√™s)</div>
                <div class="stat-value" id="birthsMonth">12</div>
                <div class="stat-change">+2 esta semana</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Vacina√ß√µes Pendentes</div>
                <div class="stat-value" id="vaccinations">23</div>
                <div class="stat-change">Pr√≥xima: 3 dias</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tipos de Cria√ß√£o</div>
                <div class="stat-value">4</div>
                <div class="stat-change">üêÑüê¥üê∑üêë Todos suportados!</div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-title">Atividade Recente</div>
            <div id="recentActivity">
                <!-- Activity items will be added here -->
            </div>
        </div>
    </div>

    <!-- Inventory Tab -->
    <div class="tab-content" id="inventory-tab">
        <div class="inventory-controls">
            <input type="text" class="search-box" placeholder="Buscar por brinco, ra√ßa, pasto..." id="searchInput">
            <select class="form-input" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px;">
                <option>Todos os Pastos</option>
                <option>Pasto Esperan√ßa</option>
                <option>Pasto Vit√≥ria</option>
                <option>Pasto Liberdade</option>
                <option>Pasto Progresso</option>
                <option>Pasto Horizonte</option>
            </select>
            <button class="filter-btn">Filtrar</button>
            <button class="action-btn">+ Adicionar Animal</button>
            <button class="action-btn">Exportar CSV</button>
        </div>

        <div class="inventory-table">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Brinco/ID</th>
                            <th>Tipo</th>
                            <th>Ra√ßa</th>
                            <th>Sexo</th>
                            <th>Idade</th>
                            <th>Peso (kg)</th>
                            <th>Pasto</th>
                            <th>Sa√∫de</th>
                            <th>√öltima Vacina√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- Cattle rows will be added here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- WhatsApp Tab -->
    <div class="tab-content" id="whatsapp-tab">
        <div class="whatsapp-container">
            <div class="message-list">
                <h3 style="margin-bottom: 20px;">Mensagens Recentes</h3>
                <div id="messageList">
                    <!-- Messages will be listed here -->
                </div>
            </div>
            <div class="chat-window">
                <div class="chat-header">
                    <strong id="chatWith">Selecione uma conversa</strong>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="chat-input">
                    <input type="text" placeholder="Digite sua mensagem..." id="messageInput">
                    <button class="send-btn" onclick="sendMessage()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-content" id="analytics-tab">
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Crescimento do Rebanho</div>
                <div class="chart-container">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Distribui√ß√£o por Pasto</div>
                <div class="chart-container">
                    <canvas id="pastureChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Custos Mensais</div>
                <div class="chart-container">
                    <canvas id="costsChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-title">Taxa de Natalidade</div>
                <div class="chart-container">
                    <canvas id="birthRateChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Weather Tab -->
    <div class="tab-content" id="weather-tab">
        <div style="text-align: center; margin-bottom: 20px;">
            <input type="text" id="cityInput" placeholder="Digite a cidade... (ex: Cuiab√°, MT)" style="padding: 10px; width: 300px; border-radius: 5px; border: 1px solid #ddd;">
            <button onclick="getWeather()" class="action-btn" style="margin-left: 10px;">Buscar Clima</button>
        </div>
        
        <div class="weather-widget">
            <h2>Clima - <span id="weatherLocation">Fazenda Demo</span></h2>
            <div class="weather-main">
                <div class="weather-temp" id="temperature">--¬∞C</div>
                <div>
                    <div id="weatherDescription">Aguardando busca...</div>
                    <div id="cityName">Digite uma cidade</div>
                </div>
            </div>
            <div class="weather-details">
                <div>
                    <div>Umidade</div>
                    <div id="humidity">--%</div>
                </div>
                <div>
                    <div>Vento</div>
                    <div id="windSpeed">-- km/h</div>
                </div>
                <div>
                    <div>Sensa√ß√£o</div>
                    <div id="feelsLike">--¬∞C</div>
                </div>
                <div>
                    <div>Press√£o</div>
                    <div id="pressure">-- hPa</div>
                </div>
            </div>
        </div>
        
        <div class="chart-card" style="margin-top: 20px;">
            <div class="chart-title">Alertas para Pecuaristas</div>
            <div id="ranchTip" style="padding: 20px; font-size: 16px; line-height: 1.5;">
                Digite uma cidade para ver alertas baseados no clima.
            </div>
        </div>
    </div>

    <!-- Milk Production Tab -->
    <div class="tab-content" id="milk-tab">
        <div class="milk-form">
            <h3>Registrar Produ√ß√£o de Leite</h3>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Data</label>
                    <input type="date" class="form-input" id="milkDate">
                </div>
                <div class="form-group">
                    <label class="form-label">Vaca ID</label>
                    <input type="text" class="form-input" placeholder="Ex: VAC001">
                </div>
                <div class="form-group">
                    <label class="form-label">Litros (Manh√£)</label>
                    <input type="number" class="form-input" placeholder="0.0">
                </div>
                <div class="form-group">
                    <label class="form-label">Litros (Tarde)</label>
                    <input type="number" class="form-input" placeholder="0.0">
                </div>
            </div>
            <button class="action-btn">Registrar Produ√ß√£o</button>
        </div>
        
        <div class="chart-card">
            <div class="chart-title">Produ√ß√£o Mensal</div>
            <div class="chart-container">
                <canvas id="milkChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-content" id="documents-tab">
        <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">üì§</div>
            <h3>Arraste arquivos aqui ou clique para fazer upload</h3>
            <p>Aceita CSV, Excel, PDF, Imagens</p>
            <input type="file" id="fileInput" style="display: none;" multiple accept=".csv,.xlsx,.xls,.pdf,.jpg,.png">
        </div>
        
        <div class="inventory-table" style="margin-top: 20px;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Nome do Arquivo</th>
                            <th>Tipo</th>
                            <th>Tamanho</th>
                            <th>Data de Upload</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="documentsTableBody">
                        <tr>
                            <td>inventario_janeiro_2024.csv</td>
                            <td>CSV</td>
                            <td>24 KB</td>
                            <td>15/01/2024</td>
                            <td><button class="action-btn">Baixar</button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Demo data
        let demoData = {
            ranchName: 'Fazenda Demo',
            totalCattle: 150,
            birthsMonth: 12,
            vaccinations: 23,
            cattle: [],
            messages: [],
            activities: [],
            charts: {}
        };

        // Generate demo cattle
        function generateDemoCattle() {
            const breeds = ['Nelore', 'Angus', 'Brahman', 'Gir', 'Guzer√°'];
            const pastures = ['Pasto Esperan√ßa', 'Pasto Vit√≥ria', 'Pasto Liberdade', 'Pasto Progresso', 'Pasto Horizonte'];
            
            demoData.cattle = [];
            for (let i = 1; i <= 150; i++) {
                demoData.cattle.push({
                    tag: `BOV${String(i).padStart(3, '0')}`,
                    type: 'Bovino',
                    breed: breeds[Math.floor(Math.random() * breeds.length)],
                    gender: Math.random() > 0.5 ? 'Macho' : 'F√™mea',
                    age: Math.floor(Math.random() * 60) + 6,
                    weight: Math.floor(Math.random() * 300) + 300,
                    pasture: pastures[Math.floor(Math.random() * pastures.length)],
                    health: Math.random() > 0.9 ? 'Em Tratamento' : 'Saud√°vel',
                    lastVaccine: new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')
                });
            }
        }

        // Generate demo messages
        function generateDemoMessages() {
            const vaqueiros = ['Jo√£o Santos', 'Pedro Silva', 'Carlos Oliveira', 'Miguel Costa', 'Jos√© Ferreira'];
            const messages = [
                'Nasceu 2 bezerros hoje no pasto norte',
                'Vacinei o lote 15 contra aftosa',
                'Transferi 30 cabe√ßas para o pasto sul',
                'Chuva de 25mm registrada',
                'Peso da vaca 501: 420kg'
            ];
            
            demoData.messages = [];
            for (let i = 0; i < 10; i++) {
                demoData.messages.push({
                    sender: vaqueiros[Math.floor(Math.random() * vaqueiros.length)],
                    message: messages[Math.floor(Math.random() * messages.length)],
                    time: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000),
                    phone: `+55 65 9${Math.floor(Math.random() * 10000000 + 10000000)}`
                });
            }
        }

        // Switch tabs - FIXED VERSION
        function switchTab(tabName, button) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Mark button as active
            button.classList.add('active');
            
            // Load tab-specific data
            if (tabName === 'inventory') {
                loadInventory();
            } else if (tabName === 'whatsapp') {
                loadMessages();
            } else if (tabName === 'analytics') {
                // IMPORTANT: Initialize charts when analytics tab is opened
                setTimeout(() => initAnalyticsCharts(), 100);
            }
        }

        // Load inventory
        function loadInventory() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            demoData.cattle.forEach(animal => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="tag-badge">${animal.tag}</span></td>
                    <td>${animal.type}</td>
                    <td>${animal.breed}</td>
                    <td>${animal.gender}</td>
                    <td>${animal.age} meses</td>
                    <td>${animal.weight}</td>
                    <td>${animal.pasture}</td>
                    <td class="${animal.health === 'Saud√°vel' ? 'status-healthy' : 'status-sick'}">${animal.health}</td>
                    <td>${animal.lastVaccine}</td>
                    <td><button class="action-btn">Editar</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load WhatsApp messages
        function loadMessages() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '';
            
            demoData.messages.sort((a, b) => b.time - a.time).forEach(msg => {
                const item = document.createElement('div');
                item.className = 'message-item';
                item.onclick = () => openChat(msg.sender, msg.phone);
                item.innerHTML = `
                    <div class="message-sender">${msg.sender}</div>
                    <div class="message-preview">${msg.message}</div>
                    <div class="message-time">${msg.time.toLocaleString('pt-BR')}</div>
                `;
                messageList.appendChild(item);
            });
        }

        // Open chat
        function openChat(sender, phone) {
            document.getElementById('chatWith').textContent = `${sender} - ${phone}`;
            document.getElementById('chatMessages').innerHTML = `
                <div class="chat-message">
                    <div class="message-bubble">Ol√°! Como est√° o gado hoje?</div>
                </div>
                <div class="chat-message sent">
                    <div class="message-bubble sent">Tudo bem! Nasceu 2 bezerros hoje.</div>
                </div>
            `;
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                const msgDiv = document.createElement('div');
                msgDiv.className = 'chat-message sent';
                msgDiv.innerHTML = `<div class="message-bubble sent">${message}</div>`;
                chatMessages.appendChild(msgDiv);
                input.value = '';
                
                // Simulate response
                setTimeout(() => {
                    const responseDiv = document.createElement('div');
                    responseDiv.className = 'chat-message';
                    responseDiv.innerHTML = `<div class="message-bubble">‚úÖ Mensagem recebida e processada!</div>`;
                    chatMessages.appendChild(responseDiv);
                    showNotification('Mensagem enviada via WhatsApp!');
                }, 1000);
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Trial timer
        function updateTrialTimer() {
            const endTime = new Date(Date.now() + 36 * 60 * 60 * 1000);
            
            setInterval(() => {
                const now = new Date();
                const remaining = endTime - now;
                
                if (remaining > 0) {
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                    
                    document.getElementById('trialTimer').textContent = 
                        `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} restantes`;
                }
            }, 1000);
        }

        // Initialize Analytics Charts - FIXED VERSION
        function initAnalyticsCharts() {
            // Destroy existing charts if they exist
            Object.values(demoData.charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Growth Chart
            const growthCtx = document.getElementById('growthChart');
            if (growthCtx) {
                demoData.charts.growth = new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                        datasets: [{
                            label: 'Total de Animais',
                            data: [120, 125, 130, 138, 145, 150],
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Pasture Distribution Chart
            const pastureCtx = document.getElementById('pastureChart');
            if (pastureCtx) {
                demoData.charts.pasture = new Chart(pastureCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pasto Esperan√ßa', 'Pasto Vit√≥ria', 'Pasto Liberdade', 'Pasto Progresso', 'Pasto Horizonte'],
                        datasets: [{
                            data: [35, 28, 25, 32, 30],
                            backgroundColor: ['#27ae60', '#2ecc71', '#16a085', '#1abc9c', '#3498db']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Costs Chart
            const costsCtx = document.getElementById('costsChart');
            if (costsCtx) {
                demoData.charts.costs = new Chart(costsCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Ra√ß√£o', 'Veterin√°rio', 'Vacinas', 'Manuten√ß√£o', 'Transporte'],
                        datasets: [{
                            label: 'Custos (R$)',
                            data: [4500, 2200, 1800, 3200, 1500],
                            backgroundColor: '#e74c3c'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Birth Rate Chart
            const birthCtx = document.getElementById('birthRateChart');
            if (birthCtx) {
                demoData.charts.birthRate = new Chart(birthCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
                        datasets: [{
                            label: 'Nascimentos',
                            data: [8, 12, 10, 15, 11, 12],
                            borderColor: '#9b59b6',
                            backgroundColor: 'rgba(155, 89, 182, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // Milk Production Chart
            const milkCtx = document.getElementById('milkChart');
            if (milkCtx) {
                demoData.charts.milk = new Chart(milkCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Semana 1', 'Semana 2', 'Semana 3', 'Semana 4'],
                        datasets: [{
                            label: 'Litros de Leite',
                            data: [850, 920, 890, 940],
                            backgroundColor: '#3498db'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' L';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Weather functions
        function getWeather() {
            const city = document.getElementById('cityInput').value;
            if (!city) {
                alert('Por favor, digite o nome de uma cidade');
                return;
            }
            
            // Show loading state
            document.getElementById('temperature').textContent = '...';
            document.getElementById('weatherDescription').textContent = 'Buscando...';
            
            // Get coordinates for Brazilian city
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city},Brazil&limit=1`)
                .then(response => response.json())
                .then(locationData => {
                    if (locationData.length === 0) {
                        alert('Cidade n√£o encontrada. Tente: Cuiab√°, Campo Grande, Goi√¢nia');
                        document.getElementById('temperature').textContent = '--¬∞C';
                        return;
                    }
                    
                    const lat = locationData[0].lat;
                    const lon = locationData[0].lon;
                    const displayName = locationData[0].display_name.split(',')[0];
                    
                    // Get REAL weather from Open-Meteo
                    return fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,precipitation,wind_speed_10m,weather_code,apparent_temperature&timezone=America/Sao_Paulo`)
                        .then(response => response.json())
                        .then(weatherData => {
                            // Update display with REAL data
                            document.getElementById('temperature').textContent = Math.round(weatherData.current.temperature_2m) + '¬∞C';
                            document.getElementById('weatherDescription').textContent = getWeatherDescription(weatherData.current.weather_code);
                            document.getElementById('cityName').textContent = displayName + ', Brasil';
                            document.getElementById('humidity').textContent = weatherData.current.relative_humidity_2m + '%';
                            document.getElementById('windSpeed').textContent = Math.round(weatherData.current.wind_speed_10m) + ' km/h';
                            document.getElementById('feelsLike').textContent = Math.round(weatherData.current.apparent_temperature) + '¬∞C';
                            document.getElementById('pressure').textContent = '1013 hPa';
                            
                            // Generate ranch alerts
                            generateRanchAlerts(weatherData.current);
                        });
                })
                .catch(error => {
                    console.error('Erro:', error);
                    document.getElementById('temperature').textContent = '--¬∞C';
                    document.getElementById('weatherDescription').textContent = 'Erro';
                });
        }

        // Convert weather codes to Portuguese
        function getWeatherDescription(code) {
            const descriptions = {
                0: 'C√©u limpo ‚òÄÔ∏è',
                1: 'Principalmente limpo üå§Ô∏è', 
                2: 'Parcialmente nublado ‚õÖ',
                3: 'Nublado ‚òÅÔ∏è',
                45: 'Neblina üå´Ô∏è',
                48: 'Geada ‚ùÑÔ∏è',
                51: 'Garoa leve üå¶Ô∏è',
                61: 'Chuva leve üåßÔ∏è',
                63: 'Chuva moderada üåßÔ∏è',
                65: 'Chuva forte üåßÔ∏è',
                80: 'Pancadas üå¶Ô∏è',
                95: 'Tempestade ‚õàÔ∏è'
            };
            return descriptions[code] || 'Vari√°vel';
        }

        // Ranch-specific alerts
        function generateRanchAlerts(current) {
            const temp = current.temperature_2m;
            const humidity = current.relative_humidity_2m;
            
            let tip = '';
            
            if (temp > 35) {
                tip = 'üî• ALERTA CALOR EXTREMO! Garanta √°gua abundante e sombra. Evite manejo entre 10h-16h.';
            } else if (temp < 10) {
                tip = '‚ùÑÔ∏è FRIO INTENSO! Forne√ßa alimenta√ß√£o extra. Proteja bezerros.';
            } else if (humidity > 85 && temp > 25) {
                tip = 'ü¶ü RISCO PARASITAS! Alta umidade favorece carrapatos. Intensifique monitoramento.';
            } else if (temp >= 20 && temp <= 28 && humidity >= 50 && humidity <= 70) {
                tip = '‚úÖ CONDI√á√ïES PERFEITAS! Ideal para vacina√ß√£o, pesagem e manejo geral.';
            } else {
                tip = 'üëç Condi√ß√µes normais para manejo do rebanho.';
            }
            
            document.getElementById('ranchTip').innerHTML = `<strong>${tip}</strong>`;
        }

        // Initialize everything
        window.onload = function() {
            generateDemoCattle();
            generateDemoMessages();
            updateTrialTimer();
            
            // Search inventory
            document.getElementById('searchInput')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#inventoryTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });

            // File upload
            document.getElementById('fileInput')?.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length > 0) {
                    showNotification(`${files.length} arquivo(s) carregado(s) com sucesso!`);
                }
            });
            
            // Enter key for message input
            document.getElementById('messageInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Simulate incoming messages
            setInterval(() => {
                if (Math.random() > 0.8) {
                    const activities = [
                        'üêÑ Nascimento registrado via WhatsApp',
                        'üíâ Vacina√ß√£o registrada via WhatsApp',
                        'üöö Movimenta√ß√£o de gado registrada',
                        'üåßÔ∏è Precipita√ß√£o registrada: 15mm'
                    ];
                    
                    const activity = activities[Math.floor(Math.random() * activities.length)];
                    showNotification(activity);
                }
            }, 15000);
        };
    </script>
</body>
</html>
